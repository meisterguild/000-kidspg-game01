# スプライト画像差し替え・アイテム追加実装計画書

## 1. 概要

本計画は、現在のゲーム内のプレイヤーおよび敵オブジェクトを、単色の四角形から画像スプライトに差し替えるとともに、新たにアイテム（スコアアップ、障害物）を追加する実装手順を定義する。

**目的:**
- ゲームの視覚的な品質を向上させる。
- アイテムの導入により、ゲームの戦略性とリプレイ性を高める。
- 今後の機能追加を容易にするため、スプライト関連の設定とロジックを分離し、保守性の高い構造を構築する。

**前提条件:**
- スプライトシート画像（`sprite_items.png`）は、すでに`src/renderer/assets/images/`に配置済みである。
- アプリケーションの既存機能は正常に動作している。

---

## 2. アーキテクチャ方針

設定とロジックの分離を徹底し、将来的な拡張性を確保する。

- **設定の一元化:**
  - スプライトシートのパス、アセットキー、各スプライトの座標・サイズ、アイテムの種類や効果といった設定情報を、`src/shared/utils/constants.ts`に`SPRITE_CONFIG`および`ITEM_CONFIG`として集約する。

- **既存アセットローダーの活用:**
  - アプリケーション起動時にアセットを読み込む既存の機構（`src/shared/utils/assets.ts`）を利用する。

- **関心の分離:**
  - `PixiGameEngine.ts`は、描画とゲームのコアロジックに専念する。
  - アセット管理（`assets.ts`）と設定管理（`constants.ts`）を明確に分離する。

- **オブジェクト指向の強化:**
  - 敵とアイテムを区別するため、`Obstacle`インターフェースに`type`プロパティ（`'enemy'`, `'item'`, `'bomb'`など）を追加する。
  - 衝突判定ロジックを`type`に応じて分岐させることで、オブジェクトごとの異なる振る舞いを実現する。

---

## 3. アイテム設計（画像解析に基づく提案）

`sprite_items.png`の画像内容を基に、以下のアイテムを導入する。

| アイテム名 | スプライト候補 | 種別 | 効果 | 発生頻度（提案） |
| :--- | :--- | :--- | :--- | :--- |
| **敵キャラクター** | `skull`, `cat_faces` | 障害物 | 接触すると即ゲームオーバー | 70% |
| **爆弾** | `bomb` | 障害物 | 接触すると即ゲームオーバー | 10% |
| **フルーツ** | `apple`, `banana`, `tomato` | アイテム | 接触するとスコアが **+50** 加算される | 15% |
| **ポーション** | `potion` | アイテム | 接触すると移動速度が一定時間 **1.5倍** になる（レベルアップとは別軸） | 5% |

- **プレイヤーキャラクター:** `player_face`（笑顔の四角形など）をデフォルトとし、将来的には選択式にすることも可能。

---

## 4. 実装ステップ詳細

### ステップ1：スプライト設定の定義

**目的:** スプライトシートに関するすべての設定情報を、単一のオブジェクトとして定義し、保守性を高める。

**対象ファイル:** `src/shared/utils/constants.ts`

**修正内容:**
以下の`SPRITE_CONFIG`オブジェクトを新しくエクスポートする。各スプライトの座標は、スプライトシートの左上を(0, 0)とするピクセル単位で指定する。

```typescript
// src/shared/utils/constants.ts に追記

export const SPRITE_CONFIG = {
  path: './assets/images/sprite_items.png',
  key: 'spriteSheet',
  player: { x: 100, y: 100, width: 50, height: 50 }, // 例: 黄色い猫の顔
  enemy: { x: 350, y: 250, width: 50, height: 50 }, // 例: ドクロ
  bomb: { x: 350, y: 500, width: 50, height: 50 },
  apple: { x: 50, y: 300, width: 50, height: 50 },
  potion: { x: 300, y: 250, width: 50, height: 50 },
} as const;
```

### ステップ2：アセット読み込みの更新

**目的:** アプリケーション起動時に、定義したスプライトシート画像を読み込み対象に加える。

**対象ファイル:** `src/shared/utils/assets.ts`

**修正内容:** （変更なし）
現在の実装で、`SPRITE_CONFIG`を参照する形になっていれば、このファイルの修正は不要。

### ステップ3：スプライト切り出し検証 (★新規追加)

**目的:** 本格的な実装の前に、`SPRITE_CONFIG`で定義した座標が正しいかを視覚的に確認し、手戻りを防ぐ。

**対象ファイル:** `src/renderer/game/PixiGameEngine.ts`

**検証手順:**
1.  **一時的なテストコードの追加:**
    -   `setupGame`メソッド内に、一時的なテストコードを記述する。
    -   `SPRITE_CONFIG`に定義されたすべてのスプライト（`player`, `enemy`, `bomb`など）をループ処理する。
    -   ループ内で、各スプライトのテクスチャを生成し、`PIXI.Sprite`として画面上に一覧表示する。
    -   各スプライトの横に、その名前（`player`, `enemy`など）を`PIXI.Text`で表示し、どの画像がどの設定に対応しているか分かるようにする。

2.  **目視による確認:**
    -   ゲームを実行し、`GamePage`が表示された際に、すべてのスプライトが意図通りに切り出されて表示されているかを確認する。
    -   座標やサイズがずれている場合は、`SPRITE_CONFIG`の値を修正し、再度確認する。

3.  **テストコードの削除:**
    -   すべてのスプライトが正しく表示されることを確認したら、このステップで追加したテストコードを完全に削除する。

### ステップ4：ゲームエンジンへの本実装

**目的:** `PixiGameEngine`の描画処理を、`PIXI.Graphics`から`PIXI.Sprite`に差し替え、アイテムロジックを実装する。

**対象ファイル:** `src/renderer/game/PixiGameEngine.ts`

**修正内容:**

1.  **プロパティとインターフェースの拡張:**
    -   各スプライト用のテクスチャを保持する`textures`プロパティを追加する。
    -   `Obstacle`インターフェースに`type`プロパティを追加する。

2.  **`setupGame`メソッドの修正:**
    -   `SPRITE_CONFIG`を基に、すべてのテクスチャを生成し、`this.textures`に格納する。
    -   プレイヤーキャラクターを`PIXI.Sprite`として生成する。

3.  **`createObstacle`メソッドの修正:**
    -   `OBSTACLE_TYPES`の重みに基づいて出現オブジェクトを抽選し、対応するテクスチャでスプライトを生成する。

4.  **`gameLoop`メソッドの修正:**
    -   衝突判定ロジックを`type`に応じて分岐させ、アイテムごとの効果（スコア加算、速度変化など）を実装する。

### ステップ5：動作確認と検証

**目的:** 修正による影響範囲を確認し、既存機能が損なわれていないことを保証する。

**検証項目:**
- **表示:** プレイヤー、敵、アイテムが正しいスプライトで表示されるか。
- **アイテム動作:** 敵との衝突、アイテム取得時の効果が正常に動作するか。
- **既存機能:** 移動、スコア加算、レベルアップ、画面遷移などがすべて正常か。

---

## 5. リスクと対策

- **リスク:** スプライトの座標指定がずれることで、開発の手戻りが発生する。
  - **対策:** ステップ3の「スプライト切り出し検証」を独立して行うことで、座標の問題を早期に特定し、解決する。
- **リスク:** テクスchaの読み込み失敗。
  - **対策:** `getImage`の戻り値チェックを徹底し、エラーログを詳細に出力する。
- **リスク:** `anchor`や`pivot`の変更による衝突判定のずれ。
  - **対策:** `getBounds()`を利用しているためリスクは低いが、目視で当たり判定を重点的に確認する。
