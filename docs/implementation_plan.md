# 実装計画書：KidsPG「xxチャレンジ系」没入型教育ゲーム

## 1. はじめに

このドキュメントは、要件定義書 `docs/main_plan.md` に基づき、開発の具体的なステップ、技術選定の理由、および開発フェーズを定義するものです。

---

## 2. 開発の全体方針

*   **イテレーション開発**: 機能単位で実装とテストを繰り返すアジャイルなアプローチを採用します。
*   **コンポーネント分割**: 「ゲーム本体」「AI機能」「Webサイト」を疎結合に保ち、それぞれ独立して開発・テストができるように設計します。
*   **技術選定**: 要件定義書に基づき、迅速なPoC（Proof of Concept）開発に適した技術スタックを選定します。

---

## 3. 技術スタックと選定理由

| 区分       | 技術構成                                       | 選定理由                                                                                               |
| :--------- | :--------------------------------------------- | :----------------------------------------------------------------------------------------------------- |
| **全体**   | **HTML5 + JavaScript (ES6+)**                  | ビルド環境への依存をなくし、Node.jsのバージョン等の制約を受けずに迅速な開発を実現するため。                |
| **ゲームUI** | **PixiJS**                                     | 高速な2Dレンダリングが可能で、Canvasベースの複雑な演出やゲームロジックの実装に適しています。                  |
| **ファイル出力** | **JavaScript (Blob, FileSaver.js)**            | サーバーサイド処理を介さず、クライアントサイドで動的に生成したデータ（JSON, PNG）をユーザーにダウンロードさせるため。 |
| **記念画像生成** | **HTML5 Canvas API**                           | クライアントサイドで動的に画像生成・装飾が可能。サーバー負荷を軽減し、リアルタイムなプレビューを実現します。       |
| **AI加工**   | **ComfyUI API (外部連携)**                     | 既存の画像生成環境であるComfyUIとAPI経由で連携。ゲーム本体は画像送信のみに責任を持ち、処理を非同期化する。 |
| **UI/CSS** | **Vanilla CSS**                                | 外部ライブラリへの依存を最小限に抑え、シンプルさと高速な読み込みを両立するため。                           |

---

## 4. 開発フェーズとタスク一覧

### フェーズ1：基盤構築とゲームプロトタイプ (Sprint 1)

*   **目標**: ゲームの基本的な動作を実装し、プレイ可能なプロトタイプを完成させる。
*   **タスク**:
    1.  **プロジェクトセットアップ**:
        *   `index.html` と `game.js` を作成し、Vanilla JSでの開発環境を構築。
        *   PixiJSをCDN経由で導入。
    2.  **ゲームシーンの構築**:
        *   PixiJSでゲームのメイン画面、キャラクター、背景の雛形を描画。
    3.  **プレイヤー操作の実装**:
        *   キーボード入力に応じてキャラクターが3レーンを移動するロジックを実装。

### フェーズ2：コアゲームメカニクスの実装 (Sprint 2)

*   **目標**: ゲームの主要なルールと進行システムを実装する。
*   **タスク**:
    1.  **障害物システム**:
        *   障害物をランダムなレーンに生成し、落下させる。
        *   プレイヤーとの衝突判定（ゲームオーバー処理）を実装。
    2.  **スコア・レベルシステム**:
        *   障害物の回避でスコアを加算し、レベルアップする仕組みを実装。
        *   レベルに応じて難易度が上昇するロジックを実装。

### フェーズ3：データ出力と記念カード (Sprint 3)

*   **目標**: AIニックネーム生成と、プレイ結果の永続化、記念カードの生成機能を実装する。
*   **タスク**:
    1.  **ニックネーム生成AI（プロトタイプ）**:
        *   単語辞書を基に、ランダムなニックネームを生成する関数を実装。
    2.  **プレイ結果の保存**:
        *   ゲーム終了時に、結果をJSONファイルとしてダウンロードする機能を追加。
    3.  **記念カード生成**:
        *   Canvas APIを使い、スコアやニックネームを載せたカード風画像を生成し、ダウンロード可能にする。

### フェーズ4：Webサイトと連携強化 (Sprint 4)

*   **目標**: プレイ結果を可視化するランキングサイトを構築し、ゲームとの連携を強化する。
*   **タスク**:
    1.  **ランキングサイト**:
        *   複数の結果JSONファイルを読み込み、スコアランキングを表示する`ranking.html`を作成。
    2.  **ページ間連携**:
        *   ゲームページからランキングページへのリンクを追加。

### フェーズ5：ComfyUI非同期連携 (Sprint 5)

*   **目標**: ゲーム開始前にカメラで撮影し、その画像をComfyUI APIへ非同期で送信する機能を実装する。
*   **タスク**:
    1.  **カメラUIの実装**:
        *   `index.html`にカメラ映像を表示する`<video>`要素と撮影・確定ボタンを配置。
        *   `game.js`にカメラアクセスと映像ストリーミングのロジックを追加。
    2.  **非同期API連携**:
        *   写真確定時に、ゲームを開始させると同時に、画像データをComfyUI APIへ`fetch`で非同期送信する機能を実装。
        *   API連携時に、後で結果を紐付けるための一意なIDを生成する。
    3.  **ゲームロジックの変更**:
        *   ゲーム本体の初期化が、写真確定ボタンの押下をトリガーにするように修正。
    4.  **結果の紐付け**:
        *   ゲームオーバー時に保存するJSONに、API連携で使った一意のIDを記録するフィールドを追加。

---

## 5. 成果物

1.  **ゲームアプリケーション**: Webブラウザで動作する実行可能なゲーム。
2.  **ランキングWebサイト**: ローカルのJSONファイルを読み込んで表示するランキングページ。
3.  **ソースコード**: Gitリポジトリで管理された全ソースコード。
4.  **ドキュメント**: 要件定義書、実装計画書。
