# 実装計画書：スプライト画像への差し替え

## 1. はじめに

このドキュメントは、`src/renderer/game/PixiGameEngine.ts`で定義されているプレイヤーキャラクター（緑四角）と敵キャラクター（赤四角）のプレースホルダーを、`src/renderer/assets/images/sprite_items.png` に含まれるスプライト画像に差し替えるための実装計画を定義します。

## 2. 目的

*   ゲームの視覚的な品質を向上させる
*   キャラクターの識別性を高める
*   よりリッチなゲーム体験を提供する

## 3. 現状分析

### 3.1 現在の実装状況
- **プレイヤーキャラクター**: `PixiGameEngine.ts:103-105`で緑色の四角形（`PIXI.Graphics`）として描画
- **敵キャラクター**: `PixiGameEngine.ts:162-164`で赤色の四角形（`PIXI.Graphics`）として描画
- **サイズ**: 両方とも50x50ピクセル
- **技術スタック**: PixiJS v8

### 3.2 使用可能なスプライト
画像分析により以下のスプライトを特定（各スプライト64x64ピクセル）：

#### 行1（Y: 0）
- (0, 0): 青いキューブ
- (64, 0): 緑のキューブ  
- (128, 0): **緑の笑顔キューブ** ⭐ プレイヤー候補
- (192, 0): 緑の球体
- (256, 0): **赤いキューブ** ⭐ 敵候補
- (320, 0): 黄色キューブ
- (384, 0): 紫キューブ

#### 行2（Y: 64）
- (0, 64): 緑のキューブ（グリッド）
- (64, 64): オレンジキューブ
- (128, 64): **赤の笑顔キューブ** ⭐ 敵候補（推奨）
- (192, 64): 青い球体
- (256, 64): 青いキューブ（X印）
- (320, 64): 青いキューブ（透明）
- (384, 64): 茶色キューブ

#### 行3（Y: 128）
- (0, 128): 紫の笑顔
- (64, 128): オレンジの笑顔
- (128, 128): 黄色い星
- (192, 128): オレンジの三角
- (256, 128): 青い水滴
- (320, 128): 青い鳥
- (384, 128): 青い稲妻

#### 行4（Y: 192）
- (0, 192): 赤い火炎
- (64, 192): ピンクの花
- (128, 192): 青い水滴
- (192, 192): 緑のリサイクル
- (256, 192): 茶色の岩
- (320, 192): 青いキューブ（3D）
- (384, 192): 青い結晶

#### 行5（Y: 256）
- (0, 256): 青いキューブ
- (64, 256): 緑の猫
- (128, 256): オレンジの猫
- (192, 256): 黄色の猫
- (256, 256): ベージュの猫
- (320, 256): 緑のポーション瓶
- (384, 256): パンダの顔

#### 行6（Y: 320）
- (0, 320): オレンジ
- (64, 320): 赤いハート
- (128, 320): 黄色いバナナ
- (192, 320): 赤いリンゴ
- (256, 320): コーヒー豆
- (320, 320): 目玉
- (384, 320): 黒い球

#### 行7（Y: 384）
- (0, 384): 茶色のクマ
- (64, 384): 白いウサギ
- (128, 384): 黄色い笑顔
- (192, 384): 黄色い笑顔（別）
- (256, 384): 赤いイチゴ
- (320, 384): 黒い爆弾
- (384, 384): 黒い球

#### 行8（Y: 448）
- (0, 448): 青い三角
- (64, 448): 青い四角
- (128, 448): 緑の円
- (192, 448): オレンジの円
- (256, 448): 青い「C」
- (320, 448): 黄色い「B」
- (384, 448): 緑の「C」

### 推奨スプライト選択
- **プレイヤーキャラクター**: 緑の笑顔キューブ（128, 0）- 親しみやすく識別しやすい
- **敵キャラクター**: 赤の笑顔キューブ（128, 64）- プレイヤーとの対比が明確

## 4. 実装タスク

### フェーズ1：アセット準備とローダー設定

#### 4.1 スプライトシート定義の作成
`src/renderer/assets/sprites/`フォルダに`sprite_items.json`を作成：
```json
{
  "frames": {
    "player": {
      "frame": { "x": 128, "y": 0, "w": 64, "h": 64 },
      "anchor": { "x": 0.5, "y": 0.5 }
    },
    "enemy": {
      "frame": { "x": 128, "y": 64, "w": 64, "h": 64 },
      "anchor": { "x": 0.5, "y": 0.5 }
    }
  },
  "meta": {
    "image": "sprite_items.png",
    "size": { "w": 448, "h": 512 },
    "scale": "1"
  }
}
```

#### 4.2 アセットローダーの実装
`PixiGameEngine.ts`の`initialize`メソッドを修正してスプライトシートをロード：
- `PIXI.Assets.load()`を使用
- 非同期処理でテクスチャとスプライトシートを読み込み

### フェーズ2：キャラクター描画の差し替え

#### 2.1 プレイヤーキャラクターの変更
`PixiGameEngine.ts:103-105`を修正：
```typescript
// 変更前（削除）
this.character = new PIXI.Graphics()
  .rect(-25, -25, 50, 50)
  .fill(0x00FF00);

// 変更後（追加）
const playerTexture = PIXI.Texture.from('player');
this.character = new PIXI.Sprite(playerTexture);
this.character.anchor.set(0.5, 0.5);
this.character.scale.set(0.78, 0.78); // 64x64を50x50相当にスケール
```

#### 2.2 敵キャラクターの変更
`createObstacle`メソッド（`PixiGameEngine.ts:162-164`）を修正：
```typescript
// 変更前（削除）
const obstacle = new PIXI.Graphics()
  .rect(-25, -25, 50, 50)
  .fill(0xFF0000);

// 変更後（追加）
const enemyTexture = PIXI.Texture.from('enemy');
const obstacle = new PIXI.Sprite(enemyTexture);
obstacle.anchor.set(0.5, 0.5);
obstacle.scale.set(0.78, 0.78);
```

### フェーズ3：調整とテスト

#### 3.1 衝突判定の確認
現在の衝突判定（`checkCollision`メソッド）はスプライトのサイズに依存しないため、変更不要。ただし以下を確認：
- `getBounds()`メソッドが正しく機能すること
- スプライトのアンカーポイントが適切に設定されていること

#### 3.2 位置調整
- プレイヤーキャラクターの初期位置とレーン移動時の位置が適切か確認
- 敵キャラクターの生成位置が適切か確認

#### 3.3 パフォーマンス検証
- テクスチャの読み込み時間が許容範囲内であること
- メモリ使用量に大幅な増加がないこと

## 5. 実装手順

1. **アセット準備**
   - スプライトシート定義ファイルの作成
   - アセットパスの確認

2. **初期化処理の修正**
   - `initialize`メソッドにアセットローダーを追加
   - 非同期読み込みの実装

3. **キャラクター生成コードの置換**
   - プレイヤーキャラクターの描画方法変更
   - 敵キャラクターの描画方法変更

4. **動作確認**
   - ゲーム起動とスプライト表示の確認
   - キャラクター移動の確認
   - 衝突判定の確認

5. **最適化**
   - パフォーマンスチューニング
   - エラーハンドリングの追加

## 6. 成果物

*   更新された `src/renderer/game/PixiGameEngine.ts`
*   新規作成される `src/renderer/assets/sprites/sprite_items.json`
*   視覚的に改善されたゲーム画面

## 7. 注意事項

*   PixiJS v8の仕様に従ってテクスチャローディングを実装する
*   既存のメモリ管理機能（`performMemoryMaintenance`）に影響しないよう配慮する
*   スプライトのサイズ変更により、ゲームバランス（当たり判定の厳しさ等）が変わる可能性を考慮する
